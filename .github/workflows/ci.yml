name: CI/CD workflow
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - name: Clonar Repositorio
      uses: actions/checkout@v4
    - name: Configurar Node.js  
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    - name: Instalar dependencias
      run: npm install    
    - name: Lint del Codigo
      run: npm run lint
    - name: Ejecutar pruebas con cobertura
      run: npm test -- --coverage
    - name: Mostrar contenido de coverage
      run: |
        ls -l coverage || echo "No existe la carpeta coverage"
    - name: Verificar cobertura mínima
      run: |
        if [ ! -f coverage/coverage-summary.json ]; then
          echo "No se generó coverage/coverage-summary.json. Verifica configuración de Jest y comando de pruebas.";
          exit 1;
        fi
        COVERAGE=$(node -e "const c=require(process.env.GITHUB_WORKSPACE + '/coverage/coverage-summary.json').total;console.log(c.lines.pct>=80 && c.branches.pct>=80 ? 'ok' : 'fail')")
        if [ "$COVERAGE" = "fail" ]; then
          echo "Coverage < 80%"; exit 1;
        fi
    - name: Subir reporte de cobertura
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage
    - name: Simular despligue
      run: |
        echo "Despliegue simulado: La aplicación pasó lint, pruebas y cobertura correctamente"
